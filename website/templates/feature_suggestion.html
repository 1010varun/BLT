{% extends "base.html" %}
{% block content %}
    {% include "includes/sidenav.html" %}
    <style>
    .container {
        display: flex;
        margin-top: 40px;
    }

    .list-section {
        flex: 2;
        padding: 10px;
        overflow-y: auto;
    }

    .form-section {
        flex: 1;
        padding: 10px;
        position: sticky;
        top: 0;
    }

    .form-section form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-section form input,
    .form-section form textarea,
    .form-section form button {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }

    .form-section form button {
        background-color: #28a745;
        color: white;
        cursor: pointer;
    }

    .suggestion-list {
        list-style: none;
        padding: 0;
    }

    .suggestion-list li {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 10px;
        margin-bottom: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    #heading-container {
        text-align: center;
    }

    #heading {
        font-size: 50px;
        font-weight: bold;
        color: white;
        margin-top: 40px;
        background-color: #e53e3e;
        padding: 10px;
        border-radius: 5px;
        display: inline-block;
    }

    #semiheading {
        font-size: 30px;
        margin-left: 70px;
    }

    a {
        padding-left: 5px;
    }

    .suggestion-vote button {
        background-color: #2b2b2b;
        border: none;
        padding: 2px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
        transition: background-color 0.3s;
    }

    .suggestion-vote button.active {
        background-color: red;
        color: white;
    }
    </style>
    <div id="heading-container">
        <h1 id="heading">Suggest Features</h1>
    </div>
    <div class="container">
        <div class="list-section">
            <ul class="suggestion-list">
                {% for suggestion in suggestions %}
                    <li>
                        <h3>{{ suggestion.title }}</h3>
                        <p>Description: {{ suggestion.description }}</p>
                        <p>
                            <strong>Name:</strong> {{ suggestion.name }}
                        </p>
                        <p>
                            <strong>Email:</strong> {{ suggestion.email }}
                        </p>
                        <div class="suggestion-vote">
                            <button type="button"
                                    onclick="upvote(event)"
                                    id="upvote---{{ suggestion.id }}">↑</button>
                            <label id="up_vote-{{ suggestion.id }}">{{ suggestion.up_vote }}</label>
                            <button type="button"
                                    onclick="downvote(event)"
                                    id="downvote---{{ suggestion.id }}">↓</button>
                            <label id="down_vote-{{ suggestion.id }}">{{ suggestion.down_vote }}</label>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="form-section">
            <h2 id="semiheading">Suggest us Features</h2>
            <form id="suggestionForm">
                {% csrf_token %}
                <label>Title</label>
                <input type="text" id="title" name="title" placeholder="Your suggestion">
                <label>Description</label>
                <textarea id="description"
                          name="description"
                          rows="4"
                          placeholder="Description of your suggestion (optional)"></textarea>
                <label>Name</label>
                <input type="text" id="name" name="name" placeholder="Your name">
                <label>Email</label>
                <input type="email" id="email" name="email" placeholder="Your email">
                <button type="submit" onclick="Savefeature()">Post Suggestion</button>
            </form>
        </div>
    </div>
    <script>
    function upvote(event) {
        const button = event.target;
        const id = button.id.split('---')[1];
        
        const upvoteBtn = document.getElementById(`upvote---${id}`);
        const downvoteBtn = document.getElementById(`downvote---${id}`);
        const upvotesLabel = document.getElementById(`up_vote-${id}`);
        const downvotesLabel = document.getElementById(`down_vote-${id}`);

        if (!upvoteBtn || !downvoteBtn || !upvotesLabel || !downvotesLabel) {
            console.error('Element not found for id:', id);
            return;
        }

        let up_vote;
        let down_vote;

        if (upvoteBtn.classList.contains('active')) {
            upvotesLabel.innerHTML = parseInt(upvotesLabel.innerHTML) - 1;
            upvoteBtn.classList.remove('active');
            up_vote=false;
        } else {
            upvotesLabel.innerHTML = parseInt(upvotesLabel.innerHTML) + 1;
            upvoteBtn.classList.add('active');
            up_vote = true;
            
            if (downvoteBtn.classList.contains('active')) {
                downvoteBtn.classList.remove('active');
                downvotesLabel.innerHTML = parseInt(downvotesLabel.innerHTML) - 1;
                down_vote = true;
            }
        }
        fetch('/vote-suggestion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ suggestion_id: id, up_vote: up_vote, down_vote: down_vote }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Vote saved:', data.votes);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function downvote(event) {
        const button = event.target;
        const id = button.id.split('---')[1];
        
        const upvoteBtn = document.getElementById(`upvote---${id}`);
        const downvoteBtn = document.getElementById(`downvote---${id}`);
        const upvotesLabel = document.getElementById(`up_vote-${id}`);
        const downvotesLabel = document.getElementById(`down_vote-${id}`);

        if (!upvoteBtn || !downvoteBtn || !upvotesLabel || !downvotesLabel) {
            console.error('Element not found for id:', id);
            return;
        }

        let up_vote;
        let down_vote;

        if (downvoteBtn.classList.contains('active')) {
            downvotesLabel.innerHTML = parseInt(downvotesLabel.innerHTML) - 1;
            downvoteBtn.classList.remove('active');
            down_vote = true;
        } else {
            downvotesLabel.innerHTML = parseInt(downvotesLabel.innerHTML) + 1;
            downvoteBtn.classList.add('active');
            down_vote = false;
            
            if (upvoteBtn.classList.contains('active')) {
                upvoteBtn.classList.remove('active');
                upvotesLabel.innerHTML = parseInt(upvotesLabel.innerHTML) - 1;
                up_vote = false;
            }
        }

        fetch('/vote-suggestion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // Fetch CSRF token from cookies
            },
            body: JSON.stringify({ suggestion_id: id, up_vote: up_vote, down_vote: down_vote }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Vote saved:', data.votes);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }



    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function Savefeature() {
        const form = document.getElementById("suggestionForm");
        const formData = new FormData(form);
        const email = formData.get('email');
        const title = formData.get('title');
        const description = formData.get('description');
        const name = formData.get('name');
        if (!isValidEmail(email)) {
            alert('Please provide a valid email address.');
            return;
        }

        if (!title || !name || !email) {
            alert('Please fill all the required fields.');
            return;
        }

        fetch('/add-suggestion/', {
            method: "POST",
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({email: email,name: name,title: title,description: description}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                form.reset();
            } else {
                alert('Error: Please fill all the fields.');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
    </script>
{% endblock content %}
